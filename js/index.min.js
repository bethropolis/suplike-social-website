const _user_id=sessionStorage.getItem("user")||"",_user_name=sessionStorage.getItem("name")||"";async function mainload(e="./inc/post.inc.php?user="){let t=0;function i(e){e.profile_picture||(e.profile_picture="default.jpg")}function a(e){e.forEach(async e=>{i(e),await $("#main-post").append(render(e))})}function s(){$("#main-post").append(`<div class='post-div shadow no-user' class='text-center'><h4> you need to follow someone in order to view post on your feed</h4>
               <p> go to <a href='search.php?q=e'><b>search</b></a> and look for a user to follow</p>  
            </div>`)}async function o(e){let s=await $.get(`${e}${_user_id}`);if(Array.isArray(s))a(s);else if(s?.type==="error")return;else if(s?.data)a(s.data),t=s.data.length;else{var o;i(o=s),$("#main-post").append(render(o))}addClick(),add_lightbox()}return $("#image_post").on("change",function(e){e.preventDefault();let t=URL.createObjectURL(event.target.files[0]);$("#type").val("img"),$("#imagedisp").attr("src",t)}),await o(e),t}function render(e){let t=e.image_text.replace(/\n/g," ").replace(/\r/g," ");if(e.image_text=t,l=e.liked?"fas like":"far",_user=!0===e.user?{name:_user_name,id:_user_id}:e.user,"img"==e.type||"txt"==e.type)return`
    <div class="post-div shadow">
    ${""!=e.repost?`
      <div class="d-flex justify-content-left py-1 px-3">
      <a
      href="post.php?id=${e.repost}"
    >
      <i class="fas fa-retweet"></i>
       <span class="mx-2">repost</span></a>
      </div>`:""}
      <div class="d-flex justify-content-between p-2 px-3">
        <div class="d-flex flex-row align-items-center">
            <a href="profile.php?id=${_user.id}">
          <img
            src="img/${e.profile_picture}"
            width="36px"
            height="36px"
            class="rounded-circle"
          />
            </a>
          <div class="d-flex flex-column ml-2">
            <a href="profile.php?id=${_user.id}">
              <small class="text-left text-muted text-primary usn py-2 ml-1">@${_user.name}
              ${e.admin?"<i class='fa fa-user-shield text-muted  mx-1'></i>":""}  
              ${e.bot?"<i class='fa fa-robot text-muted  mx-1'></i>":""}</small>
            </a>
          </div>
        </div>

        <div class="d-flex flex-row mt-1 ellipsis">
          <small class="mr-2 text-muted">${e.date_posted}</small>
          <a
            class="dropdown-toggle cob"
            href="#"
            role="button"
            id="dropdownMenuLink"
            data-toggle="dropdown"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <i class="fa fa-ellipsis-h"></i>
          </a>
          <div
            class="dropdown-menu cob dropdown-menu-right shadow animated--fade-in bga"
            aria-labelledby="dropdownMenuLink"
            style=""
          >
            <div class="dropdown-header">Actions:</div>
            <a
              class="dropdown-item mj-actions post-page"
              href="post.php?id=${e.post_id}"
            >
              <i class="fa fa-eye fa-fw"></i> View Post
            </a>
            ${_user.name==_user_name?`<a class="dropdown-item delete mj-actions" href="inc/post.inc.php?del_post=${e.post_id}">
                <i class="fa fa-trash fa-fw"></i> Delete Post
              </a>`:""}
            <a
              class="dropdown-item mj-actions share"
              id="${e.post_id}"
              href="#share"
            >
              <i class="fa fa-share-alt fa-fw"></i> Share
            </a>
            <a class="dropdown-item mj-actions report" id="${e.id}" href="#report">
              <i class="fa fa-flag fa-fw"></i> Report
            </a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="profile.php?id=${_user.id}">visit profile</a>
          </div>
        </div>
      </div>
      ${"img"===e.type?`
        <div class="lazyload">
          <!-- <a href="./img/${e.image}" data-lightbox="${e.post_id}" data-title="${e.image_text}" data-image-alt="image post">
            <div class="post-body" style="background-image: url(./img/${e.image});"></div>
          </a> -->
        </div>
        <p class="lone co p-1">${e.image_text}</p>
        `:`
        <div class="px-1 py-3">
          <p class="lone co px-2">${e.image_text}</p>
        </div>
        `}
      <div class="social-opt">
        <div class="row social-act co w-100">
          <div class="col-3 flex icon">
            <i title="like" tabindex="0" role="button" id="${e.id}" class="${l} mr-1  this-click fa-heart"></i>
            <small class="${e.id}">${e.post_likes<=0?"":e.post_likes}</small>
          </div>
          <div class="col-3 flex icon">
            <a href="./comment.php?id=${e.post_id}">
              <i title="comment" id="comment" class="fas mr-1  fa-comment comment"></i>
            </a>
            <small>${e.comments<=0?"":e.comments}</small>
          </div>
          <div class="col-3 icon">
            <a href="#share" class="share" id="${e.post_id}">
              <i title="share this post" class="fas fa-share"></i>
            </a>
          </div>
          <div class="col-3 icon">
            <a href="inc/repost.inc.php?id=${e.post_id}" class="repost">
              <i title="repost this post" class="fas fa-retweet"></i>
            </a>
          </div>
        </div>
      </div>
    </div>`}function addClick(){$(".this-click").click(function(e){let t=`./inc/like.inc.php?user=${_user_id}&id=${this.id}`,i=`.${this.id}`,a=Number($(i).text()),s=this.classList.contains("fas")?-1:1;$(i).text(a+s),$(this).attr("class",1===s?"fas fa-heart  mr-1 icon-click like":"far fa-heart  mr-1 icon-click like"),$.get(`${t}&like=${a+s}&key=${1===s?"true":"false"}`,function(e){})}),$(".share").click(async function(e){e.preventDefault;let t=window.location.pathname.split("/");t[t.length-1]&&t.pop();let i=`${t.join("/")}/post.php?id=${this.id}`;i=window.location.origin+i;let a={url:i};try{await navigator.share(a),$.post("./inc/share.inc.php",{id:_user_id})}catch(s){}}),$(".report").click(function(e){e.preventDefault,$.post("./inc/report.inc.php",{id:this.id},function(e){alert(e)})}),$(".tocome").click(function(){alert("I am still working on this...")}),$(".lazyload").lazyload()}async function profile_request(e){let t=`./inc/profile.inc.php?id=${e}&user=${_user_id}`,i=await fetch(t),a=await i.json();if(a.user){let{usersFirstname:s,usersSecondname:o,uidusers:n,chat_auth:r,following:p,followers:c,no_posts:d,bio:f,profile_picture:u,posts:h}=a.user,m=s?`${s} ${o}`:"";$("#profile-name").text(m),$(".userName").text(`@${n}`),$(".message-btn").attr("href",`message.php?id=${r}`),$("#following").text(p),$("#followers").text(c),$("#posts").text(d),$(".bio").html(f),$(".profile-pic").attr("src",null!==u?`img/${u}`:"img/default.jpg"),$(".btn").toggle(a!==n),follow(),h&&(await Promise.all(h.map(async e=>{e.profile_picture||(e.profile_picture="default.jpg"),await $("#main-post").append(await render(e))})),addClick())}else $(".bio").text("an unknown user"),$(".btn").hide()}function post_request(e){url="./inc/post.inc.php?id="+e,$.get(url,function(e){e.profile_picture=e.user.profile_picture,e.profile_picture||(e.profile_picture="img/default.jpg"),$("#main-post").append(render(e)),addClick()})}function get_popular_users(){$.get("./inc/search.inc.php?type=users&query",function(e){"success"==e.type?(e.data.forEach(e=>{let t=e.following?"following":"follow";$("#popular-users").append(`
        <li class="text-left  align-items-center p-2 border-0  justify-content-between"
        style='display: flex;'>
        <a href="profile.php?id=${e.token}">
        <span class='link co border-0'>@${e.uidusers}</span>
         </a>
        <button id='${e.token}' class=" bg p-1 text-center text-white  border-0  outline-0 follower-btn follow-btn p-0" 
        style='outline: none; border-radius: 5px; width: 40%; position: relative; overflow: hidden'>
        <span class="small">${t}</span>
        </button>
    </li>`)}),follow(_user_id)):$("#popular-users").append("<div class='text-center w-full'>Not logged in</div>")})}function get_popular_tags(){$.get("./inc/search.inc.php?type=tags&query",function(e){"success"==e.type?e.data.forEach(e=>{$("#popular-tags").append(`
        <a href="topics.php?t=${e.name}" class=" border-0 page-link tab_bg link">
          <li class="text-left align-items-center p-2 border-0  justify-content-between"
          style='display: flex;'>
            <span class='co border-0'>#${e.name}</span>
            <span class="small mx-2">view</span>    
          </li>
        </a>
    `)}):$("#popular-users").append("<div class='text-center w-full'>Not logged in</div>")})}function follow(e){e=e||_user_id,$(".follow-btn").click(function(){var t=this.id||profile,i="follow"===$(this).children("span").text().trim(),a=$("#followers"),s=parseInt(a.text());i?($(this).children("span").text("following"),$(this).children("i").attr("class","fas fa-user  ml-2 no-h  text-white"),s++):($(this).children("span").text("follow"),$(this).children("i").attr("class","fas fa-user-plus ml-2 no-h  text-white "),s--),a.text(s);var o=`./inc/follow.inc.php?user=${e}&following=${t}&key=${i}`;$.get(o,function(e){"error"==e.type&&alert(e.message||e.msg)})})}function add_lightbox(){$("body").append('<script defer src="./lib/lightbox/js/lightbox.min.js"></script>  ')}function active_page(e){$(`.${["purple","pink","yellow","teal","blue"][e]}`).addClass("active")}$("body").on("keydown",function(e){if(13===e.keyCode||32===e.keyCode){var t=$(e.target);"0"===t.attr("tabindex")&&(t.click(),e.preventDefault())}}),$("#logout").click(function(){sessionStorage.clear()});